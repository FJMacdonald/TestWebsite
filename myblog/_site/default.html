<!-- Set Up Your Website: Create the structure of your website using HTML, CSS, and JavaScript. 
You'll need an HTML file to create the user interface, a CSS file for styling,
 and a JavaScript file to handle the file upload and D3.js visualization.

Create the User Interface: 
Design the user interface where users can upload their CSV files. You can use HTML form elements 
and styling to create an intuitive and user-friendly interface.

Implement File Upload Functionality: Write JavaScript code to handle the file upload process. 
Use the File API to allow users to select and upload CSV files from their local device. 
You'll also need to handle the file upload event and read the contents of the uploaded CSV file.

Parse and Process the CSV Data: Once the CSV file is uploaded, parse its contents using JavaScript. 
You can use libraries like Papa Parse to parse CSV data easily. Process the data as needed to prepare 
it for visualization with D3.js.

Visualize the Data with D3.js: Use D3.js to create custom visualizations based on the data from the CSV file. 
You can create various types of charts, graphs, or other visualizations to present the data in a special way 
according to your requirements.

Test Your Website: Before deploying your website, thoroughly test it to ensure that the file upload and
visualization functionalities work correctly across different browsers and devices.
Deploy Your Website: Once you're satisfied with your website, deploy it to your chosen hosting platform. 
Follow the instructions provided by the hosting platform to deploy your website for free.

Share Your Website: Share the URL of your website with others so they can upload their CSV files and explore
 the visualizations you've created with D3.js.
By following these steps, you can create a free website that allows users to upload CSV files
 and presents the data in a special way using D3.js for visualization. -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/test.css">
    <title>CSV File Upload</title>
</head>

<body>
    <h4>Instructions:</h4>
    <ul>
        <li>Get results file from https://triathlon.org/results</li>
        <li>Download the XLS file, open it and save it as a CSV file.</li>
        <li>Open the CSV file here.</li>
    </ul>
    </p>
    <!-- Initialize the ffile select button -->
    <input class="button" type="file" id="csvFileInput" accept=".csv">
    <!-- <div id="csvData"></div> -->
    <label for="fileSelect">Select a File:</label>
    <select id="fileSelect">
        <option value="" disabled selected>Select a file</option>
    </select>

    <!-- Initialize the reset button -->
    <button class="button" id="resetButton" style="margin-bottom: 10px">Reset</button>

    <!-- Create a div where the graph will take place -->
    <div>
        <div id="chart_problems"></div>
        <div id="chart_title"></div>
        <div id="development_chart"></div>
        <div id="spiderchart_title"></div>
        <div id="spider_chart" style="width: 100%;"></div>
        <div id="hit_counter"><span id="hitCount">0</span></div>
    </div>
    <script src="https://d3js.org/d3-color.v1.min.js"> </script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"> </script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"> </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/js/developmentChart.js"></script>
    <script>
        // List of filenames (replace with your filenames)
        const filenames = [
            "Results for Elite Women - 2023 Americas Triathlon Cup St. Peters Missouri.csv",
            "Results for Elite Women - 2024 Americas Triathlon Championships Miami.csv",
            "Results for Junior Women - 2023 Americas Triathlon North American Junior Championships Sarasota.csv",
            "Results for Junior Women - 2023 World Triathlon Sprint & Relay Championships Hamburg.csv",
        ];

        // Populate the dropdown menu with filenames
        const fileSelect = document.getElementById('fileSelect');
        filenames.forEach(filename => {
            const option = document.createElement('option');
            option.text = filename;
            option.value = filename;
            fileSelect.appendChild(option);
        });

        // Add event listener to dropdown menu
        fileSelect.addEventListener('change', function() {
            const selectedFilename = fileSelect.value;
            if (selectedFilename) {
                // Construct the URL for the selected file
                const fileURL = '/results/' + selectedFilename;
                // make a fetch request to get the file content
                fetch(fileURL)
                    .then(response => response.text())
                    .then(data => {
                        console.log(data);
                        // Handle the file data, for example, process the CSV content
                        processData(data, athletesArray, leadersArray);
                        // draw development chart
                        drawChart(athletesArray, leadersArray);
                    })
                    .catch(error => {
                        console.error('Error fetching file:', error);
                    });
            }
        });



        
        const errorResult = 99999;
        const athletesArray = [];
        const leadersArray = [];
        const spiderChartArray = [];
        var athleteIndexArray = [];

        var max_time_lag = 0;
        var title = "";

        // Add event listener for file input change
        const fileInput = document.getElementById('csvFileInput');
        fileInput.addEventListener('change', handleFileUpload);

        // Add event listener for reset chart button
        const reset = document.getElementById('resetButton');
        reset.addEventListener('change', drawChart(athletesArray, leadersArray));

        // Function to handle file upload
        function handleFileUpload(event) {
            // clear any previous chart
            var svg = d3.select("#development_chart")
            svg.selectAll('*').remove();
            // clear previous problem data sets
            let chartProblemDiv = document.getElementById("chart_problems");
            chartProblemDiv.innerHTML = "";
            chartProblemDiv.style.border = "none";

            //reset the data arrays
            athletesArray.length = 0
            leadersArray.length = 0
            max_time_lag = 0;

            const file = event.target.files[0]; // Get the uploaded file
            title = file["name"].replace(/Results for |.csv/g, "");
            // Get the div element by its ID
            let chartTitleDiv = document.getElementById("chart_title");

            // Update the inner HTML of the div with the new title
            chartTitleDiv.innerHTML = "<h1>" + title + "</h1>";

            // Create a new FileReader object
            const reader = new FileReader();
            // Define the onload event handler for the FileReader
            reader.onload = function (e) {
                const csvData = e.target.result; // Get the CSV data
                //   displayCSVData(csvData); // Call function to display CSV data
                processData(csvData, athletesArray, leadersArray);

                drawChart(athletesArray, leadersArray);
            };

            // Read the uploaded file as text
            reader.readAsText(file);
        }

        // Function to display CSV data
        function displayCSVData(csvData) {
            const csvDataDiv = document.getElementById('csvData'); // Get the div element
            csvDataDiv.textContent = csvData; // Display the CSV data in the div
        }

        // Function converts time String formated as hr:min:sec to an int of seconds
        function convertToSeconds(timeString) {
            // Split the time string into hours, minutes, and seconds
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            // Convert hours, minutes, and seconds to seconds
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            return totalSeconds;
        }

        // Function to process csv data into arrays used by drawChart
        function processData(csvData, athletesArray, leadersArray) {
            const lines = csvData.split('\n');
            const headers = lines[0].split(',');

            const results = [];
            //process csv file into a results array
            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentline = lines[i].split(',');
                headers.forEach((header, index) => {
                    obj[header] = currentline[index];
                });
                results.push(obj);
            }


            // Convert time strings to seconds and store each stage of the race
            var leadSwim = 0;
            var leadT1 = 0;
            var leadBike = 0;
            var leadT2 = 0;
            var leadRun = 0;
            var problemTimes = 0;
            var problemIndexArray = [];
            const swim1 = convertToSeconds(results[0]["Swim"]);
            const t11 = convertToSeconds(results[0]["T1"]);
            const bike1 = convertToSeconds(results[0]["Bike"]);
            const t21 = convertToSeconds(results[0]["T2"]);
            const run1 = convertToSeconds(results[0]["Run"]);
            var fastestSplits = [swim1, t11, bike1, t21, run1];
            var slowestSplits = [swim1, t11, bike1, t21, run1];
            var timePerDisipline = [];
            for (let i = 0; i < results.length; i++) {
                var name = results[i]["Athlete First Name"] + " " + results[i]["Athlete Last Name"];
                var finalTime = results[i][headers[headers.length - 1]].replace(/\r$/, '');

                var swim = convertToSeconds(results[i]["Swim"]);
                if (swim != 0) {
                    if (swim < fastestSplits[0]) {
                        fastestSplits[0] = swim;
                    } else if (swim > slowestSplits[0]) {
                        slowestSplits[0] = swim;
                    }
                }
                var t1 = convertToSeconds(results[i]["T1"]);
                const t1_abs = t1;
                if (t1 != 0) {
                    t1 += swim;
                    if (t1_abs < fastestSplits[1]) {
                        fastestSplits[1] = t1_abs;
                    } else if (t1_abs > slowestSplits[1]) {
                        slowestSplits[1] = t1_abs;
                    }
                }
                var bike = convertToSeconds(results[i]["Bike"]);
                const bike_abs = bike;
                if (bike != 0) {
                    bike += t1;
                    if (bike_abs < fastestSplits[2]) {
                        fastestSplits[2] = bike_abs;
                    } else if (bike_abs > slowestSplits[2]) {
                        slowestSplits[2] = bike_abs;
                    }
                }
                var t2 = convertToSeconds(results[i]["T2"]);
                const t2_abs = t2;
                if (t2 != 0) {
                    t2 += bike;
                    if (t2_abs < fastestSplits[3]) {
                        fastestSplits[3] = t2_abs;
                    } else if (t2_abs > slowestSplits[3]) {
                        slowestSplits[3] = t2_abs;
                    }
                }
                var run = convertToSeconds(results[i]["Run"]);
                const run_abs = run;
                if (run != 0) {
                    run += t2;
                    if (run_abs < fastestSplits[4]) {
                        fastestSplits[4] = run_abs;
                    } else if (run_abs > slowestSplits[4]) {
                        slowestSplits[4] = run_abs;
                    }
                }
                var finalTimeInSeconds = convertToSeconds(finalTime);
                if (Math.abs(finalTimeInSeconds - run) > 5) {
                    problemIndexArray.push(i)
                    problemTimes++;
                }
                timePerDisipline = [swim, t1_abs, bike_abs, t2_abs, run_abs];
                if (i == 0) {
                    leadSwim = swim;
                    leadT1 = t1;
                    leadBike = bike;
                    leadT2 = t2;
                    leadRun = run;
                 //   console.log(swim, t1, bike, t2, run);
                //    console.log("lead swimmer: " + name);
                } else {
                    if (swim != 0 && swim < leadSwim) {
                        leadSwim = swim;
                       // console.log("lead swimmer: " + name);
                    }
                    if (t1 != 0 && t1 < leadT1) {
                        leadT1 = t1;
                      //  console.log("lead t1: " + name);
                    }
                    if (bike != 0 && bike < leadBike) {
                        leadBike = bike;
                       // console.log("lead biker: " + name);
                    }
                    if (t2 != 0 && t2 < leadT2) {
                        leadT2 = t2;
                    //    console.log("lead t2: " + name);
                    }
                    if (run != 0 && run < leadRun) {
                        leadRun = run;
                    //    console.log("lead runner: " + name);
                    }
                    
                }
                athletesArray.push({
                    athleteName: name,
                    swim: swim,
                    t1: t1,
                    bike: bike,
                    t2: t2,
                    run: run,
                    timePerDisipline: timePerDisipline,
                    position: results[i]["Position"],
                    status: results[i]["Status"],
                    country: results[i]["Country"],
                });

                leadersArray[0] = leadSwim;
                leadersArray[1] = leadT1;
                leadersArray[2] = leadBike;
                leadersArray[3] = leadT2;
                leadersArray[4] = leadRun;
            }
            normalizeResults(fastestSplits, slowestSplits);

            if (problemIndexArray.length > 0) {
                let chartTitleDiv = document.getElementById("chart_problems");
                var problemString = "There were issues with " + problemIndexArray.length + " athlete results:<ul>"
                var problems = 0;
                for (let i = 0; i < problemIndexArray.length; i++) {
                    if (athletesArray[problemIndexArray[i]].status == "") {
                        problemString += "<li>" + athletesArray[problemIndexArray[i]].athleteName + "</li>";
                        athletesArray[problemIndexArray[i]].athleteName += "***";
                        problems++;
                    }
                }
                if (problems > 0) {

                    problemString += "</ul>"
                    // Update the inner HTML of the div with the new title
                    chartTitleDiv.innerHTML = problemString;
                    // Add a red border to the chartTitleDiv
                    chartTitleDiv.style = "border: 1px solid red; border-radius: 5px;";
                }
            }
        }











   
        function normalizeResults(fastestSplits, slowestSplits) {
            for (let i = 0; i < athletesArray.length; i++) {
                var normalizedSwim = 1 - (athletesArray[i].timePerDisipline[0] - fastestSplits[0]) / (slowestSplits[0] - fastestSplits[0]);
                var normalizedT1 = 1 - (athletesArray[i].timePerDisipline[1] - fastestSplits[1]) / (slowestSplits[1] - fastestSplits[1]);
                var normalizedBike = 1 - (athletesArray[i].timePerDisipline[2] - fastestSplits[2]) / (slowestSplits[2] - fastestSplits[2]);
                var normalizedT2 = 1 - (athletesArray[i].timePerDisipline[3] - fastestSplits[3]) / (slowestSplits[3] - fastestSplits[3]);
                var normalizedRun = 1 - (athletesArray[i].timePerDisipline[4] - fastestSplits[4]) / (slowestSplits[4] - fastestSplits[4]);
                //using > 2 in case a normalized value ends up as 1.00002
                if (normalizedSwim > 2){
                    console.log(athletesArray[i].athleteName, "swim", athletesArray[i].timePerDisipline[0]);
                    normalizedSwim = 0;
                }
                if (normalizedT1 > 2){
                    console.log(athletesArray[i].athleteName, "t1", athletesArray[i].timePerDisipline[1]);
                    normalizedT1 = 0;
                }
                if (normalizedBike > 2){
                    console.log(athletesArray[i].athleteName, "bike", athletesArray[i].timePerDisipline[2]);
                    normalizedBike = 0;
                }
                if (normalizedT2 > 2){
                    console.log(athletesArray[i].athleteName, "t2", athletesArray[i].timePerDisipline[3]);
                    normalizedT2 = 0;
                }                
                if (normalizedRun > 2){
                    console.log(athletesArray[i].athleteName, "run", athletesArray[i].timePerDisipline[4]);
                    normalizedRun = 0;
                }
                spiderChartArray.push({
                    athleteName: athletesArray[i].athleteName,
                    values: {
                        'Swim': normalizedSwim,
                        'T1': normalizedT1,
                        'Bike': normalizedBike,
                        'T2': normalizedBike,
                        'Run': normalizedRun
                    },
                    position: athletesArray[i].position,
                    status: athletesArray[i].status,
                });
            }
        }









        function drawSpiderChart(selectedAthletes) {
            let chartTitleDiv = document.getElementById("spiderchart_title");

            // Update the inner HTML of the div with the new title
            chartTitleDiv.innerHTML = "<h3> Spider Chart </h3>";
            
            var selectedAthletes = [];
            for (let i = 0; i < athleteIndexArray.length; i++) {
                selectedAthletes.push(spiderChartArray[athleteIndexArray[i]]);
            }

            // set the dimensions and margins of the graph
            var margin = { top: 10, right: 10, bottom: 0, left: 10 };
            var width = d3.select("#spider_chart").node().getBoundingClientRect().width - margin.left - margin.right;
            var height = 400 - margin.top - margin.bottom;
            if (width < 500)
                margin.bottom = 50;
            // append the svg object to the body of the page
            d3.select("#spider_chart").selectAll('*').remove();
            var spider_svg = d3.select("#spider_chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // Create a rectangle for the frame
            var frame = spider_svg.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", width)
                .attr("height", height + margin.bottom)
                .attr("rx", 10)
                .attr("ry", 10)
                .attr("stroke", "gray")
                .attr("opacity", 0.6)
                .attr("stroke-width", 2)
                .attr("fill", "transparent");

                //clear previous graph
                d3.select('spider_svg').selectAll('.athlete-group').remove();
                // Create a group for all athletes
                const athleteGroup = spider_svg.append("g")
                    .attr("class", "athlete-group");



                var lineOpacity = "0.3";


                // Define the size and spacing of the rectangles
                const size = 25;
                const rectSpacing = 5;


                let features = ["Swim", "T1", "Bike", "T2", "Run"];


                var color = d3.scaleOrdinal()
                    .domain(selectedAthletes)
                    .range(d3.schemeSet2);

                let radialScale = d3.scaleLinear()
                    .domain([0, 1])
                    .range([0, 140]); // this dictates the size/scale of the spider chart
                let ticks = [0.2, 0.4, 0.6, 0.8, 1];


                athleteGroup.selectAll("circle")
                    .data(ticks)
                    .join(
                        enter => enter.append("circle")
                            .attr("cx", width / 2)
                            .attr("cy", height / 2)
                            .attr("fill", "none")
                            .attr("stroke", "gray")
                            .attr("r", d => radialScale(d))
                    );
                athleteGroup.selectAll(".ticklabel")
                    .data(ticks)
                    .join(
                        enter => enter.append("text")
                            .attr("class", "label ticklabel")
                            .attr("x", width / 2 + 5)
                            .attr("y", d => height / 2 - radialScale(d))
                            .text(d => d.toString())
                           // .style("font-size", "12px")
                    );

                function angleToCoordinate(angle, value) {
                    let x = Math.cos(angle) * radialScale(value);
                    let y = Math.sin(angle) * radialScale(value);
                    return { "x": width / 2 + x, "y": height / 2 - y };
                }

                let featureData = features.map((f, i) => {
                    let angle = (Math.PI / 2) + (2 * Math.PI * i / features.length);
                    return {
                        "name": f,
                        "angle": angle,
                        "line_coord": angleToCoordinate(angle, 1.02),
                        "label_coord": angleToCoordinate(angle, 1.15)
                    };
                });
                // draw axis line
                athleteGroup.selectAll("line")
                    .data(featureData)
                    .join(
                        enter => enter.append("line")
                            .attr("x1", width / 2)
                            .attr("y1", height / 2)
                            .attr("x2", d => d.line_coord.x)
                            .attr("y2", d => d.line_coord.y)
                            .attr("stroke", "black")
                    );

                // draw axis label
                athleteGroup.selectAll(".axislabel")
                    .data(featureData)
                    .join(
                        enter => enter.append("text")
                            .attr("x", d => d.label_coord.x)
                            .attr("y", d => d.label_coord.y)
                            .attr("class", "label")
                            .text(d => d.name)
                    )
                    .attr("transform",
                        "translate(-10, 5)");
                let line = d3.line()
                    .x(d => d.x)
                    .y(d => d.y);


                function getPathCoordinates(data_point) {
                    let coordinates = [];
                    for (var i = 0; i < features.length; i++) {
                        let ft_name = features[i];
                        let angle = (Math.PI / 2) + (2 * Math.PI * i / features.length);
                        coordinates.push(angleToCoordinate(angle, data_point[ft_name]));
                    }
                    return coordinates;
                }
                const opacity_on = 0.5;
                const opacity_off = 0;

                // Create a rectangle for each athlete in a single vertical line
                athleteGroup.selectAll("myrects")
                    .data(selectedAthletes)
                    .enter()
                    .append("rect")
                    .attr("x", function (d, i) {
                        even = i % 2
                        if (width > 500) {
                            return margin.left;
                        } else {
                            return margin.left + even * width / 2;
                        }
                    })
                    .attr("y", function (d, i) {
                        if (width > 500) {
                            return margin.top + i * (size + rectSpacing);
                        } else {
                            if (i < 2)
                                return height - 30;
                            else
                                return height + rectSpacing;
                        }
                    })
                    .attr("width", size)
                    .attr("height", size)
                    .attr("fill", (i) => color(i))
                    .style("stroke", "Black")
                    .style("stroke-width", 1)
                    .style("opacity", 1)
                    .on("click", function (d, i) {
                        // Toggle opacity of the clicked rectangle
                        const clickedRect = d3.select(this);
                        const currentOpacity = parseFloat(clickedRect.style('opacity'));
                        const newOpacity = currentOpacity === 1 ? lineOpacity : 1;
                        clickedRect.style('opacity', newOpacity);


                        // Replace spaces with hyphens in the class name
                        const className = i.athleteName.replace(/\s+/g, '-').toLowerCase();
                        const pathOpacity = currentOpacity === 1 ? opacity_off : opacity_on;
                        // Select the path using the modified class name
                        const clickedPath = athleteGroup.select(`.${className}`);
                        clickedPath.transition()
                            .ease(d3.easeLinear)
                            .duration(300)
                            .style("opacity", pathOpacity);
                    });
                //Add athlete name next to rect
                athleteGroup.selectAll("mylabels")
                    .data(selectedAthletes)
                    .enter()
                    .append("text")
                    .attr("class", "label")
                    .attr("x", function (d, i) {
                        even = i % 2
                        if (width > 500) {
                            return margin.left + size + rectSpacing;
                        } else {
                            return margin.left + even * width / 2 + size + rectSpacing;
                        }
                    })
                    .attr("y", function (d, i) {
                        if (width > 500) {
                            return margin.top + i * (size + rectSpacing) + size / 2;
                        } else {
                            if (i < 2)
                                return height + size / 2 + rectSpacing - 30;
                            else
                                return height + size / 2 + rectSpacing;
                        }
                    })
                    .text((i) => i.athleteName)
                    .attr("fill", (i) => color(i))
                    .style("alignment-baseline", "middle");




                // draw the path element
                athleteGroup.selectAll("path")
                    .data(selectedAthletes)
                    .join(
                        enter => enter.append("path")
                            .attr("d", d => line(getPathCoordinates(d.values)))
                            .attr("class", d => {
                                // Replace spaces with hyphens in the class name
                                const className = d.athleteName.replace(/\s+/g, '-').toLowerCase();
                                return className;
                            })
                            .attr("stroke-width", 3)
                            .attr("stroke", (i) => color(i))
                            .attr("fill", (i) => color(i))
                            .attr("stroke-opacity", 1)
                            .style("opacity", opacity_on)
                    );

            };
        





        // Function to retrieve the current hit count from localStorage
        function getHitCount() {
            return localStorage.getItem('hitCount') || '0';
        }

        // Function to update the hit count and display it on the page
        function updateHitCount() {
            var hitCount = parseInt(getHitCount()) + 1;
            localStorage.setItem('hitCount', hitCount);
            document.getElementById('hitCount').textContent = hitCount;
        }

        // Call the updateHitCount function to increment the hit count
        updateHitCount();

    </script>
</body>

</html>